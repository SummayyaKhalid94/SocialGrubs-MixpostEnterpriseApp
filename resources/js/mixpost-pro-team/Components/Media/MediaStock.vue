<script setup>
import {computed, inject, onMounted} from "vue";
import {usePage, Link} from "@inertiajs/vue3";
import useAuth from "@p/Composables/useAuth";
import {snakeCase} from "lodash";
import useMedia from "@p/Composables/useMedia";
import MediaSelectable from "@p/Components/Media/MediaSelectable.vue";
import MediaFile from "@p/Components/Media/MediaFile.vue";
import Masonry from "@p/Components/Layout/Masonry.vue";
import SearchInput from "@p/Components/Util/SearchInput.vue";
import MediaCredit from "@p/Components/Media/MediaCredit.vue";
import NoResult from "@p/Components/Util/NoResult.vue";
import Alert from "@p/Components/Util/Alert.vue";
import PrimaryButton from "@p/Components/Button/PrimaryButton.vue";
import {capitalize} from "lodash";

const workspaceCtx = inject('workspaceCtx');

const props = defineProps({
    columns: {
        type: Number,
        default: 3
    },
    maxSelectedItems: {
        type: Number,
        default: -1 //infinite
    }
})

const {user} = useAuth();

const appName = computed(() => {
    return snakeCase(usePage().props.app.name);
})

const stockPhotoProvider = computed(() => {
    return usePage().props.stock_photo_provider;
})

const enabled = computed(() => {
    return usePage().props.is_configured_service[stockPhotoProvider.value];
})

const {
    isLoaded,
    keyword,
    items,
    endlessPagination,
    selected,
    toggleSelect,
    deselectAll,
    isSelected,
    createObserver
} = useMedia('mixpost.media.fetchStock', {workspace: workspaceCtx.id}, props.maxSelectedItems);

onMounted(() => {
    if (enabled.value) {
        createObserver();
    }
});

defineExpose({selected, deselectAll})
</script>
<template>
    <div v-if="enabled">
        <SearchInput v-model="keyword" :placeholder="$t(`service.stock_photo.search`, {provider: capitalize(stockPhotoProvider)})"/>

        <div v-if="items.length" class="mt-lg">
            <Masonry :items="items" :columns="columns">
                <template #default="{item}">
                    <MediaSelectable v-if="item" :active="isSelected(item)" @click="toggleSelect(item)">
                        <MediaFile :media="item">
                            <MediaCredit>
                                <div>{{ $t('media.image_source') }}: <a
                                    :href="item.source_url"
                                    target="_blank" class="link">{{capitalize(stockPhotoProvider)}}</a>
                                </div>
                                <div>{{ $t('media.author') }}: <a :href="item.credit_url"
                                                                  target="_blank" class="link">{{ item.name }}</a>
                                </div>
                            </MediaCredit>
                        </MediaFile>
                    </MediaSelectable>
                </template>
            </Masonry>
        </div>

        <NoResult v-if="isLoaded && !items.length" class="mt-lg">{{ $t('media.no_images_found') }}</NoResult>

        <div ref="endlessPagination" class="-z-10 w-full"/>
    </div>

    <template v-if="!enabled">
        <Alert variant="warning" :closeable="false">
            {{ $t('service.not_configured_service', {service: `${capitalize(stockPhotoProvider)}`}) }}
        </Alert>

        <template v-if="user.is_admin">
            <Link :href="route('mixpost.services.index')" class="block mt-md">
                <PrimaryButton>{{ $t('media.click_configure') }}</PrimaryButton>
            </Link>
        </template>
    </template>
</template>

<script setup>
import {inject, onMounted, onUnmounted, provide, reactive, ref, watch} from "vue";
import {useI18n} from "vue-i18n";
import {Head} from '@inertiajs/vue3';
import {router} from "@inertiajs/vue3";
import emitter from "@p/Services/emitter";
import useNotifications from "@p/Composables/useNotifications";
import {cloneDeep, pickBy, throttle, uniq} from "lodash";
import useSelectable from "@p/Composables/useSelectable";
import PageHeader from '@p/Components/DataDisplay/PageHeader.vue';
import PostsFilter from '@p/Components/Post/PostsFilter.vue';
import Tabs from "@p/Components/Navigation/Tabs.vue"
import Tab from "@p/Components/Navigation/Tab.vue"
import Panel from "@p/Components/Surface/Panel.vue";
import Checkbox from "@p/Components/Form/Checkbox.vue";
import Table from "@p/Components/DataDisplay/Table.vue";
import TableRow from "@p/Components/DataDisplay/TableRow.vue";
import TableCell from "@p/Components/DataDisplay/TableCell.vue";
import PureDangerButton from "@p/Components/Button/PureDangerButton.vue";
import PostItem from "@p/Components/Post/PostItem.vue";
import SelectableBar from "@p/Components/DataDisplay/SelectableBar.vue";
import Pagination from "@p/Components/Navigation/Pagination.vue";
import NoResult from "@p/Components/Util/NoResult.vue";
import TrashIcon from "@p/Icons/Trash.vue";
import PostDeletionConfirmationModal from "@p/Components/Post/PostDeletionConfirmationModal.vue";

const {t: $t} = useI18n()

const props = defineProps({
    filter: {
        type: Object,
        default: {}
    },
    posts: {
        type: Object,
    },
    has_failed_posts: {
        type: Boolean,
        default: false
    },
    has_needs_approval_posts: {
        type: Boolean,
        default: false
    },
    support_post_deletion: {
        type: Object
    }
});

const filter = ref({
    keyword: props.filter.keyword,
    status: props.filter.status,
    tags: props.filter.tags,
    accounts: props.filter.accounts
})

const postContext = reactive({
    urlMeta: {},
});

provide('postCtx', postContext);

const {
    selectedRecords,
    putPageRecords,
    toggleSelectRecordsOnPage,
    deselectRecord,
    deselectAllRecords
} = useSelectable();

const workspaceCtx = inject('workspaceCtx');

const itemsId = () => {
    return props.posts.data.map(item => item.id);
}

onMounted(() => {
    putPageRecords(itemsId());

    emitter.on('postDelete', id => {
        deselectRecord(id);
    });
});

onUnmounted(() => {
    emitter.off('postDelete');
})

watch(() => cloneDeep(filter.value), throttle(() => {
    router.get(route('mixpost.posts.index', {workspace: workspaceCtx.id}), pickBy(filter.value), {
        preserveState: true,
        only: ['posts', 'filter']
    });
}, 300))

watch(() => props.posts.data, () => {
    putPageRecords(itemsId());
})

const {notify} = useNotifications();
const confirmationDeletion = ref(false);

const deletePosts = ({deleteMode}) => {
    return new Promise((resolve, reject) => {
        router.delete(route('mixpost.posts.delete', {workspace: workspaceCtx.id}), {
            data: {
                posts: selectedRecords.value,
                status: filter.value.status,
                delete_mode: deleteMode
            },
            onSuccess() {
                deselectAllRecords();
                if (['app_only', 'app_and_social'].includes(deleteMode)) {
                    notify('success', props.filter.status === 'trash' ? $t("post.posts_deleted") : $t("post.posts_to_trash"))
                }
                if (['social_only'].includes(deleteMode)) {
                    notify('success', $t("post.posts_deleted_from_social_platforms"))
                }
                confirmationDeletion.value = false;

                resolve();
            },
            onError() {
                reject();
            }
        });
    });
}
</script>
<template>
    <Head :title="$t('post.posts')"/>

    <div class="row-py">
        <PageHeader :title="$t('post.posts')">
            <PostsFilter v-model="filter" class="md:ml-xs md:rtl:ml-0 md:rtl:mr-xs"/>
        </PageHeader>

        <div class="w-full row-px">
            <Tabs>
                <Tab @click="filter.status = null" :active="!$page.props.filter.status">{{ $t('general.all') }}</Tab>
                <Tab @click="filter.status = 'draft'" :active="$page.props.filter.status === 'draft'">
                    {{ $t("post.drafts") }}
                </Tab>
                <template v-if="has_needs_approval_posts">
                    <Tab @click="filter.status = 'needs_approval'"
                         :active="$page.props.filter.status === 'needs_approval'">
                        {{ $t("post.needs_approval") }}
                    </Tab>
                </template>
                <Tab @click="filter.status = 'scheduled'" :active="$page.props.filter.status === 'scheduled'">
                    {{ $t("post.scheduled") }}
                </Tab>
                <Tab @click="filter.status = 'published'" :active="$page.props.filter.status === 'published'">
                    {{ $t("post.published") }}
                </Tab>
                <template v-if="has_failed_posts">
                    <Tab @click="filter.status = 'failed'" :active="$page.props.filter.status === 'failed'"
                         class="text-red-500">{{ $t("post.failed") }}
                    </Tab>
                </template>
                <Tab @click="filter.status = 'trash'" :active="$page.props.filter.status === 'trash'">
                    {{ $t("general.trash") }}
                </Tab>
            </Tabs>
        </div>

        <div class="w-full row-px mt-lg">
            <SelectableBar :count="selectedRecords.length" @close="deselectAllRecords">
                <PureDangerButton @click="confirmationDeletion = true" v-tooltip="$t('general.delete')">
                    <TrashIcon/>
                </PureDangerButton>
            </SelectableBar>

            <Panel :with-padding="false">
                <Table>
                    <template #head>
                        <TableRow>
                            <TableCell component="th" scope="col" class="w-10">
                                <Checkbox v-model:checked="toggleSelectRecordsOnPage" :disabled="!posts.meta.total"/>
                            </TableCell>
                            <TableCell component="th" scope="col" class="w-44">{{ $t("post.status") }}</TableCell>
                            <TableCell component="th" scope="col" class="pl-0! text-left">
                                {{ $t("post.content") }}
                            </TableCell>
                            <TableCell component="th" scope="col" class="w-48">{{ $t("post.media") }}</TableCell>
                            <TableCell component="th" scope="col">{{ $t("post.labels") }}</TableCell>
                            <TableCell component="th" scope="col">{{ $t("post.accounts") }}</TableCell>
                            <TableCell component="th" scope="col"/>
                        </TableRow>
                    </template>
                    <template #body>
                        <template v-for="item in posts.data" :key="item.id">
                            <PostItem :item="item" :filter="posts.filter"
                                      :supportPostDeletion="support_post_deletion"
                                      @onDelete="()=> {deselectRecord(item.id)}">
                                <template #checkbox>
                                    <Checkbox v-model:checked="selectedRecords" :value="item.id"/>
                                </template>
                            </PostItem>
                        </template>
                    </template>
                </Table>

                <NoResult v-if="!posts.meta.total" :withPadding="true">{{ $t("post.no_posts_found") }}</NoResult>
            </Panel>

            <div v-if="posts.meta.links.length > 3" class="mt-lg">
                <Pagination :meta="posts.meta" :links="posts.links"/>
            </div>
        </div>
    </div>
    <PostDeletionConfirmationModal
        :posts="posts.data.filter(post => selectedRecords.includes(post.id))"
        :supportPostDeletion="support_post_deletion"
        :deleteHandler="deletePosts"
        :show="confirmationDeletion"
        @close="confirmationDeletion = false"
    />
</template>
